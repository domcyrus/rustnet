name: Test FreeBSD Build

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'Cargo.toml'
      - 'build.rs'
      - 'src/**'
      - '.github/workflows/test-freebsd.yml'

env:
  RUST_BACKTRACE: 1

jobs:
  test-freebsd-build:
    name: Test FreeBSD x64 Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build and test on FreeBSD
        uses: vmactions/freebsd-vm@b9c3f24600acdef618ef1c9e2d3c6eeda4dce712  # v1.2.7
        with:
          usesh: true
          prepare: |
            pkg install -y curl libpcap rust
          run: |
            echo "Building for FreeBSD without default features (no eBPF)"
            cargo build --verbose --release --no-default-features

            echo "Verifying binary was created"
            if [ -f "target/release/rustnet" ]; then
              echo "✅ FreeBSD binary successfully built"
              ls -lh target/release/rustnet
            else
              echo "❌ FreeBSD binary not found"
              exit 1
            fi

      - name: Upload binary as artifact
        uses: actions/upload-artifact@v5
        with:
          name: rustnet-freebsd-x64
          path: target/release/rustnet
          if-no-files-found: error
